<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <!--<link rel="stylesheet" type="text/css" th:href="@{/css/chat.css}"/>-->
    <link rel="stylesheet" th:href="@{/css/talk.css}"></link>
    <script th:src="@{/webjars/jquery/2.2.4/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/3.3.6/js/bootstrap.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/3.3.6/js/tab.js}"></script>
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/file-upload.js}"></script>
    <script th:src="@{/js/web-socket.js}"></script>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/3.3.6/css/bootstrap.min.css}"></link>
  </head>
  <body th:with="userInfo = ${user}">
  <!-- header area -->
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/enter">
            Practice(Spring Boot Chat)
          </a>
        </div>

        <div class="collapse navbar-collapse" id="navbar">
          <div class="navbar-right">
            <!-- TODO Chage user information -->
            <p class="navbar-text">ようこそ <span th:text="${userInfo.userName()}"></span> さん。</p>
            <input class="btn navbar-btn" type="button" id="make-channel-btn"
                   data-toggle="modal" data-target="#modal-create-channel" value="部屋の作成"></input>
            <input class="btn navbar-btn" type="button" id="logout-btn" value="ログアウト"></input>
          </div>
        </div>
      </div>
    </nav>
    <!-- /header area -->
    <!-- Main area -->
    <div class="container-fluid">
      <div class="col-md-3 sidebar">
        <!-- channel list area(left area) -->
        <div class="panel panel-default">
          <div class="panel-heading">
            チャンネル一覧
          </div>
          <div class="panel-body">
            <div class="text-right">
              <div class="btn-group">
                <button type="button" class="btn btn-default btn-xs dropdown-toggle"
                        data-toggle="dropdown" aria-expanded="false">
                  リスト更新
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" id="update-interval">
                  <li role="presentation">
                    <a href="#" role="menuitem" tabindex="-1" data-interval="0" selected="true">
                      <span class="glyphicon glyphicon-ok" aria-hidden="true" id="check-icon"></span>なし
                    </a>
                  </li>
                  <li role="presentation"><a href="#" role="menuitem" tabindex="-1" data-interval="3">3秒</a></li>
                  <li role="presentation"><a href="#" role="menuitem" tabindex="-1" data-interval="5">5秒</a></li>
                  <li role="presentation"><a href="#" role="menuitem" tabindex="-1" data-interval="10">10秒</a></li>
                  <li role="presentation"><a href="#" role="menuitem" tabindex="-1" data-interval="30">30秒</a></li>
                  <li role="presentation"><a href="#" role="menuitem" tabindex="-1" data-interval="60">60秒</a></li>
                </ul>
              </div>
            </div>
            <ul class="list-group">
              <li class="list-group-item">
                <a data-toggle="collapse" href="#reg-grp" class="list-menu">
                  <span class="glyphicon glyphicon-plus"></span>登録済
                </a>
                <div id="reg-grp" class="panel-collapse collapse in">
                  <div class="panel-body">
                    <!--/*/ <th:block th:each="channels : ${channelList}" th:with="channel = ${channels.getChannel()}"> /*/-->
                    <div class="input-group">
                      <a href="#" class="open-channel btn btn-default form-control" th:id="|channel-${channel.id}|"
                         th:attr="data-channel-id=${channel.id},data-channel-name=${channel.channelName}"
                         onclick="openChannel($(this))">
                        <label class="join-channel-name" th:text="${channel.channelName}"></label>
                        <span class="badge" th:text="${channels.getUnread()}"></span>
                      </a>
                      <a href="#" class="withdrawal-btn btn btn-default input-group-addon" aria-hidden="true"
                         data-toggle="modal" data-target="#modal-withdrawal-channel"
                         th:attr="data-channel-id=${channel.id},data-channel-scope=${channel.channelScope}">
                        <i class="glyphicon glyphicon-remove-circle" data-toggle="tooltip" title="登録解除" data-placement="left"></i>
                      </a>
                    </div>
                    <!--/*/ </th:block> /*/-->

                    <div class="input-group" id="join-list-base" style="display:none">
                      <a href="#" class="open-channel btn btn-default form-control" id=""
                         data-channel-id="" data-channel-name="" onclick="openChannel($(this))">
                        <label class="join-channel-name"></label>
                        <span class="badge"></span>
                      </a>
                      <a href="#" class="withdrawal-btn btn btn-default input-group-addon" aria-hidden="true"
                         data-toggle="modal" data-target="#modal-withdrawal-channel" data-channel-id="">
                        <i class="glyphicon glyphicon-remove-circle" data-toggle="tooltip" title="登録解除" data-placement="left"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item" th:if="${!#lists.isEmpty(invitationList)}">
                <a data-toggle="collapse" href="#inv-grp" class="list-menu">
                  <span class="glyphicon glyphicon-plus"></span>招待済
                </a>
                <div id="inv-grp" class="panel-collapse collapse">
                  <div class="panel-body">
                    <div class="list-group">
                      <!--/*/ <th:block th:each="channels : ${invitationList}" th:with="channel = ${channels.getChannel()}"> /*/-->
                      <a href="#" class="btn btn-xs btn-default list-group-item" th:id="|channel-${channel.id}|"
                         th:attr="data-channel-id=${channel.id},data-channel-name=${channel.channelName},data-channel-scope=${channel.channelScope}"
                         data-toggle="modal" data-target="#modal-join-channel">
                        <label th:text="${channel.channelName}"></label>
                      </a>
                      <!--/*/ </th:block> /*/-->
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item">
                <a data-toggle="collapse" href="#other-grp" class="list-menu">
                  <span class="glyphicon glyphicon-plus"></span>未登録
                </a>
                <div id="other-grp" class="panel-collapse collapse">
                  <div class="panel-body">
                    <div class="list-group">
                      <!--/*/ <th:block th:each="channels : ${abstentionList}" th:with="channel = ${channels.getChannel()}"> /*/-->
                      <a href="#" class="btn btn-xs btn-default list-group-item" th:id="|channel-${channel.id}|"
                         th:attr="data-channel-id=${channel.id},data-channel-name=${channel.channelName},data-channel-scope=${channel.channelScope}"
                         data-toggle="modal" data-target="#modal-join-channel">
                        <label th:text="${channel.channelName}"></label>
                      </a>
                      <!--/*/ </th:block> /*/-->
                    </div>
                  </div>
                </div>
              </li>
            </ul>
            <input type="hidden" id="channel-id"></input>
          </div>
        </div>
      </div>
      <!-- /channel list area(left area) -->
      <!-- message area -->
      <div class="col-md-6">
        <div class="panel panel-default">
          <div class="panel-heading">
            <div id="status-msg" style="color: #f00">未接続</div>
          </div>
          <div class="panel-body">
            <form th:action="@{/file/upload}" method="post" enctype="multipart/form-data" id="file-upload-form" class="panel-form" draggable="true">
              <div class="receive-area" id="messages">
              </div>
              <input id="fileInput" type="file" value="" name="uploadFile" style="display:none"></input>
            </form>
          </div>
          <div class="panel-footer">
            <form class="panel-form">
              <fieldset id="msg-field" disabled="disabled">
                <div class="form-group" style="margin:unset">
                  <div class="input-group">
                    <input class="form-control" type="text" id="message" placeholder="入力してください。"></input>
                    <span class="input-group-btn">
                      <input class="btn btn-default" type="button" id="send-message" value="送信"></input>
                      <input class="btn btn-default" type="button" id="leave-channel" value="退席"></input>
                    </span>
                  </div>
                </div>
              </fieldset>
            </form>
          </div>
        </div>
      </div>
      <!-- /message area -->
      <!-- channel create area -->
      <div class="col-md-2">
        <!-- 右スペース -->
        <div id="channel-information" style="display:none">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#joiners-tab" data-toggle="tab">参加者</a></li>
            <li><a href="#attached-tab" data-toggle="tab">添付ファイル</a></li>
          </ul>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="joiners-tab">
            </div>
            <div role="tabpanel" class="tab-pane" id="attached-tab">
            </div>
          </div>
        </div>
      </div>
      <!-- /channel create area -->
    </div>
    <!-- /Main area -->
    <!-- /Footer area -->
    <div class="footer-area">
    </div>
  <!-- /Footer area -->
  <!-- modal area -->
  <input type="hidden" id="modal-channel-id"></input>
  <input type="hidden" id="modal-channel-scope"></input>
  <!-- modal join channel -->
  <div class="modal" id="modal-join-channel">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">参加確認</h4>
        </div>
        <div class="modal-body">
          チャンネルに参加しますか？
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="join-channel-btn" data-dismiss="modal">参加します！</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">やめる</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /mnodal join channel -->
  <!-- modal withdrawal channel -->
  <div class="modal" id="modal-withdrawal-channel">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">登録解除</h4>
        </div>
        <div class="modal-body">
          <label id="modal-withdrawal-msg-normal">チャンネル登録を解除しますか？</label>
          <label id="modal-withdrawal-msg-invitation">招待されたチャンネルの登録を解除すると、再度招待されるまで登録出来なくなりますがよろしいですか？</label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="withdrawal-channel-btn" data-dismiss="modal">解除します</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">やっぱり残る</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /mnodal withdrawal channel -->
  <!-- modal create channel -->
  <div class="modal fade" id="modal-create-channel">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">チャンネル作成</h4>
        </div>
        <div class="modal-body">
          <form id="create-channel-form">
            <div class="form-group">
              <label class="input-group">チャンネル名</label>
              <input class="form-control" type="text" name="channel_name" id="make-channel-name"></input>
            </div>
            <div class="form-group">
              <label class="input-group">公開範囲</label>
              <div class="btn-group" data-toggle="buttons" role="group">
                <label class="btn btn-default scope-group active" data-toggle="collapse" href="#set-all" data-parent="#set-parent">
                  <input type="radio" class="btn">全体</input>
                </label>
                <!--<label class="btn btn-default scope-group" data-toggle="collapse" href="#set-group" data-parent="#set-parent">
                  <input type="radio" class="btn">指定グループ</input>
                </label>-->
                <label class="btn btn-default scope-group" data-toggle="collapse" href="#set-user" data-parent="#set-parent">
                  <input type="radio" class="btn">指定ユーザー</input>
                </label>
              </div>
              <div class="panel-group" id="set-parent">
                <div class="panel">
                  <div id="set-all" class="panel-collapse collapse in">
                    <div class="panel-body">全体に公開します</div>
                    <input type="hidden" name="channel_scope" value="all"></input>
                  </div>
                  <!--<div id="set-group" class="panel-collapse collapse">
                    <div class="panel-body">グループ表示</div>
                    <input type="hidden" name="channel_scope" value="GROUP"></input>
                  </div>-->
                  <div id="set-user" class="panel-collapse collapse">
                    <div class="panel-body">ユーザー選択</div>
                    <!--/*/ <th:block th:each="user : ${userList}"> /*/-->
                    <div class="checkbox">
                      <label><input type="checkbox" name="scope_target" th:value="${user.userId()}" th:text="${user.userName()}"></input></label>
                    </div>
                    <!--/*/ </th:block> /*/-->
                    <input type="hidden" name="channel_scope" value="user"></input>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="create-channel-btn" data-dismiss="modal">作成</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">キャンセル</button>
        </div>
      </div>
    </div>
  </div>
  <!-- /mnodal withdrawal channel -->
  <!-- /modal area -->
    <form name="join-channel" id="join-channel" th:action="@{/talk}" method="post">
      <input type="hidden" name="user_id" id="user-id" th:value="${userInfo.userId()}"></input>
      <input type="hidden" name="user_name" id="user-name" th:value="${userInfo.userName()}"></input>
    </form>
    <th:block th:if="${userInfo.authority().name()}=='ROLE-ADMIN'">
      <form th:action="@{/admin}" method="post">
        <input type="submit" value="管理画面へ"></input>
      </form>
    </th:block>
    <form id="logout-form" th:action="@{/logout}" method="post">
    </form>
</body>
<script type="text/javascript" th:inline="javascript">
//<![CDATA[
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });

    /* Logout */
    $("#logout-btn").on("click", function() {
        conClose();
        $("#logout-form").submit();
    });

    $(".list-menu").on("click", function() {
        var $iconTag = $(this).find("span.glyphicon");
        if ($iconTag.hasClass("glyphicon-plus")) {
            $iconTag.removeClass("glyphicon-plus");
            $iconTag.addClass("glyphicon-minus");
        } else {
            $iconTag.removeClass("glyphicon-minus");
            $iconTag.addClass("glyphicon-plus");
        }
    });

    /* Channel open */
    var openChannel = function ($this) {
        if ($this.hasClass("active")) {
            return false;
        }
        conClose();
        $("#channel-id").val($this.data("channel-id"));
        connect();
        var channelName = $this.data("channel-name");
        $("#status-msg").html(channelName + "に接続中");
        $this.addClass("active");
        $this.find("span.badge").text("0");
        $.when(
            loadHistory(),
            loadChannelInfo()
        )
        .done(function() {
            $("#channel-information").show();
            msgScroll();
            sendConnectMessage();
        });
    }

    /* Join Channel */
    $("#modal-join-channel").on("show.bs.modal", function (event) {
        var $target = $(event.relatedTarget);
        $("#modal-channel-id").val($target.data("channel-id"));
    });

    $("#join-channel-btn").on("click", function() {
        var channelId = $("#modal-channel-id").val();
        // DB登録
        $.ajax({
            type: "GET",
            url: '/channel/join',
            data: {
                  channelId:channelId,
                  userId: $("#user-id").val()
            },
            success: function(result){
                // 登録済へ移動
                var $this = $("#channel-" + channelId);
                var $clone = $("#join-list-base").clone().removeAttr("id");
                $clone.find("a.withdrawal-btn").attr("data-channel-id", $this.data("channel-id"));
                $clone.find("a.open-channel").attr("data-channel-id",$this.data("channel-id"))
                                .attr("data-channel-name",$this.data("channel-name"))
                                .attr("id", "channel-" + $this.data("channel-id"));
                $clone.find("label.join-channel-name").text($this.data("channel-name"));
                $("#reg-grp div.panel-body").append($clone);
                $clone.find("i").tooltip();
                $clone.show();
                $this.remove();
                listUpdate();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    });

    // 送信
    $('#send-message').click(function() {
        sendNormalMessage();
    });

    // 離席
    $('#leave-channel').on("click", function() {
        conClose();
        $("#status-msg").html("未接続");
    });

    /* withdrawal Channel */
    $("#modal-withdrawal-channel").on("show.bs.modal", function (event) {
        var $target = $(event.relatedTarget);
        $("#modal-channel-id").val($target.data("channel-id"));
        var scope = $target.data("channel-scope");
        $("#modal-channel-scope").val(scope);
        if (!!scope && scope !== "all") {
          $("#modal-withdrawal-msg-invitation").show();
          $("#modal-withdrawal-msg-normal").hide();
        } else {
          $("#modal-withdrawal-msg-invitation").hide();
          $("#modal-withdrawal-msg-normal").show();
        }
    });

    $("#withdrawal-channel-btn").on("click", function() {
        $.ajax({
            type: "GET",
            url: '/channel/withdrawal',
            data: {
                  channelId:$("#modal-channel-id").val(),
                  userId: $("#user-id").val()
            },
            success: function(result){
                var $this = $("#channel-" + $("#modal-channel-id").val());
                if ($("#modal-channel-scope").val() == 'all') {
                    // 未登録へ移動
                    var $clone = $this.clone();
                    //$this.remove();
                    // クラスを変更
                    $clone.addClass("btn-xs").removeClass("open-channel").removeClass("form-control").addClass("list-group-item");
                    // modal表示を変更
                    $clone.attr("data-target", "#modal-join-channel");
                    $clone.attr("data-toggle", "modal");
                    // バッジ削除
                    $clone.find("span.badge").remove();
                    // onclick削除
                    $clone.removeAttr("onclick");
                    $("#other-grp div.list-group").append($clone);
                }
                $this.parent("div.input-group").remove();
                listUpdate();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    });

    // 閉鎖
    $("#delete-channel-btn").on("click", function() {
        $("#delete-channel-btn").attr("disabled", true);
        $.ajax({
            type: "GET",
            url: '/channel/delete',
            data: {channelId:$("#channel-id").val()},
            success: function(result){
                if (result["result"] === "success") {
                    // 閉鎖メッセージを送信
                    sendCloseMessage();
                } else {
                    alert("閉鎖に失敗しました。");
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    });

    /* Restore closed Channel */
    $("#restore-channel-btn").on("click", function() {
          $.ajax({
              type: "GET",
              url: '/channel/restore',
              data: {channelId:$("#channel option:selected").val()},
              success: function(result){
                  if (result["result"] === "success") {
                      $("#channel option:selected").attr("data-invalid", "false").change();
                      listUpdate();
                  } else {
                      $("#create-err-msg").text("チャンネルの復旧に失敗しました。");
                      $("#make-channel-name").val("");
                  }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown){
              }
          });
    });

    /* Create new Channel */
    $("#create-channel-btn").on("click", function() {
        var channelScope = $($("#modal-create-channel").find(".scope-group.active").attr("href"))
                              .find("input[name=channel_scope]").val();
        var scopeTargetArray = $($("#modal-create-channel").find(".scope-group.active").attr("href")).find("input[name=scope_target]:checked");
        var scopeTarget = "";
        var sep = "";
        $.each(scopeTargetArray, function(i, target) {
            scopeTarget = scopeTarget + sep + $(target).val();
            sep = ",";
        });
        if (valCheck()) {
            $.ajax({
                type: "GET",
                url: '/channel/make',
                data: {
                        channelName:$("#make-channel-name").val(),
                        userId:$("#user-id").val(),
                        channelScope: channelScope,
                        scopeTarget: scopeTarget
                },
                success: function(result){
                    if (result["result"] === "success") {
                        //listUpdate();
                    } else {
                        $("#create-err-msg").text("同名のチャンネルがすでに存在するため、別の名前を入力してください。");
                        $("#make-channel-name").val("");
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown){
                }
            });
        }
    });

    function valCheck() {
        if (!!!$("#make-channel-name").val()) {
            alert("チャンネル名を入力してください。");
            return false;
        }
        if ($("#make-channel-name").val().length > 18) {
        }
        return true;
    }

    /* message history load */
    function loadHistory() {
        var df = $.Deferred();
        $.ajax({
            type: "GET",
            url: '/history/load',
            data: {
                  channelId:$("#channel-id").val()
            },
            success: function(result){
                var msgArea = $("#messages");
                $.each(result, function(i, history) {
                    var type = history.type;
                    if (type == "message") {
                        msgArea.append(messageTag(history.message, history.userName, history.userId));
                    } else if (type == "file-link") {
                        var imgObj = {};
                        imgObj.saveFileName = history.message;
                        imgObj.fileName = history.message.substr(15);
                        imgObj.userName = history.userName;
                        imgObj.userId = history.userId;
                        msgArea.append(fileLinkTag(imgObj));
                    }
                });
                /*var $lastImg = msgArea.find("img").last();
                if (!!$lastImg) {
                    $lastImg.on("load", function() {
                        df.resolve();
                    })
                }*/
                imageScroll();
                df.resolve();
                //msgScroll();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
                df.resolve();
            }
        });
        return df.promise();
    }

    function loadChannelInfo() {
        var df = $.Deferred();
        // チャンネル情報を取得
        $.ajax({
            type: "GET",
            url: '/channel/info',
            data: {
              channelId: $("#channel-id").val()
            },
            success: function(result){
                var joiners = result.joiners;
                $.each(joiners, function(i, e) {
                    var joinersTag = $("<div></div>").text(e.name);
                    $("#joiners-tab").append(joinersTag);
                });
                var attachments = result.attachments;
                $.each(attachments, function(i, e) {
                    var divTag = $("<div></div>");
                    var fileTag = $("<a></a>").attr("href", "/file/download/" + e.id).text(e.originalFileName).attr("download", e.originalFileName);
                    $("#attached-tab").append(divTag.append(fileTag));
                });
                df.resolve();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
                df.resolve();
            }
        });
        return df.promise();
    }

    /* Update Channel List */
    var timerId = null;
    var lastInterval = "0";
    var listUpdate = function() {
        $.ajax({
            type: "GET",
            url: '/channel/listupdate',
            data: {userId:$("#user-id").val()},
            success: function(result){
                result.forEach(function(channels){
                    var channel = channels.channel;
                    var channelTag = $("#channel-" + channel.id);
                    if (!!channelTag) {
                        channelTag.find("span.badge").text(channels.unread);
                    }
                })
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    }
    var doListUpdate = function() {
        listUpdate();
        timerId = setTimeout(doListUpdate, lastInterval * 1000);
    }

$(function() {
    var intervalChange = function() {
        var selInterval = $("#update-interval li a[selected]").data("interval");
        if (!!timerId
                && (lastInterval !== selInterval)) {
            console.log("clear setTimeout");
            clearTimeout(timerId);
        }
        lastInterval = selInterval;
        if (selInterval == "0") {
            return;
        }
        doListUpdate();
    }

    $("#update-interval").on("click", "li a", function(event) {
        // 初期化
        $("#update-interval li a").removeAttr("selected");
        $("#check-icon").remove();
        // selectedを目印につける
        $(this).attr("selected", true);
        // チェックアイコンを付ける
        var checkIconTag = $("<span></span>").addClass("glyphicon glyphicon-ok").attr("aria-hidden", true).attr("id", "check-icon");
        $(this).prepend(checkIconTag);
        intervalChange();
    });
    intervalChange();
});

$('#file-upload-form').on('dragover', function(evt){
  evt.preventDefault();
  $('#drag-drop-area').addClass('dragover');
});

$('#file-upload-form').on('drop', function(evt){
    doUploadFile(evt)
});
//]]>
</script>
</html>
