<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <link rel="stylesheet" type="text/css" th:href="@{/css/chat.css}"/>
    <script th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/js/stomp.js}"></script>
    <script th:src="@{/js/chat-context.js}"></script>
  </head>
  <body th:with="userInfo = ${user}">
    <form name="join_channel" id="join_channel" th:action="@{/talk}" method="post">
    <!-- header area -->
    <div class="header_area">
      <div>
        ようこそ&nbsp;<span th:text="${userInfo.userName()}"></span>&nbsp;さん
        <input type="button" id="logout_btn" value="ログアウト"></input>
      </div>
    </div>
    <!-- /header area -->
    <!-- channel list area(left area) -->
      <div class="channel_select_area">
        <span>Channel List</span><div class="pos_right"><span>リスト更新</span>
        <select id="update_interval">
          <option value="0">なし</option>
          <option value="3">3秒</option>
          <option value="5">5秒</option>
          <option value="10">10秒</option>
          <option value="30" selected="true">30秒</option>
          <option value="60">60秒</option>
        </select>
        </div>
        <div>
          <select id="channel" name="channel_id" size="5">
              <!--/*/ <th:block th:each="channels : ${channelList}"> /*/-->
              <!--/*/ <th:block th:with="channel = ${channels.getChannel()},
                            state = ${channels.getState()},
                            stateStr = ${channels.getState() == 'JOINING' ? '参加中' : '未参加'},
                            condition = ${channels.getCondition()}"> /*/-->
              <option th:value="${channel.id}" th:id="|channel_${channel.id}|" th:text="|${channel.channelName}（${stateStr}）（${condition}）|"
                  th:attr="data-invalid=${channel.invalidateFlag},data-owner-id=${channel.createUserId},data-state=${state}"></option>
              <!--/*/ </th:block> /*/-->
              <!--/*/ </th:block> /*/-->
          </select>
        </div>
        <div class="pos_right">
          <input type="button" id="join_channel_btn" value="参加" disabled="true"></input>
          <input type="button" id="leave_channel_btn" value="脱退" disabled="true"></input>
          <input type="button" id="restore_channel_btn" value="復旧" disabled="true" style="display:none"></input>
          <input type="button" id="close_channel_btn" value="閉鎖" disabled="true" style="display:none"></input>
          <input type="button" id="join_channel_btn_2" value="参加(without stomp)"></input>
        </div>
      </div>
    <!-- /channel list area(left area) -->
    <!-- Main area -->
    <div class="channel_create_area">
      <div>
        <span>部屋を作成</span>
        <div>
          <input type="text" id="make_channel_name" placeholder="作成するチャンネル名を入力"></input>
          <input type="button" id="make_channel_btn" value="作成"></input>
        </div>
      </div>
      <input type="hidden" name="user_id" id="user_id" th:value="${userInfo.userId()}"></input>
      <input type="hidden" name="user_name" id="user_name" th:value="${userInfo.userName()}"></input>
    </div>
    <div class="err_msg" id="create_err_msg"></div>
    <!-- /Main area -->
    <!-- /Footer area -->
      <div class="footer_area">
      </div>
    <!-- /Footer area -->
    </form>
    <th:block th:if="${userInfo.authority().name()}=='ROLE_ADMIN'">
      <form th:action="@{/admin}" method="post">
        <input type="submit" value="管理画面へ"></input>
      </form>
    </th:block>
    <form id="logout_form" th:action="@{/logout}" method="post">
    </form>
</body>
<script type="text/javascript" th:inline="javascript">
//<![CDATA[
$(function() {

    /* Logout */
    $("#logout_btn").on("click", function() {
        $("#logout_form").submit();
    });

    /* Select List */
    $("#channel").on("change", function () {
        var $selOpt = $("#channel option:selected");
        var invalid = $selOpt.attr("data-invalid").toLowerCase() === "true";
        var isOwner = $selOpt.attr("data-owner-id") === $("#user_id").val();

        $("#join_channel_btn").attr("disabled", !!invalid);
        $("#restore_channel_btn").toggle(!!invalid && isOwner).attr("disabled", !invalid);;
        $("#close_channel_btn").toggle(!invalid && isOwner).attr("disabled", !!invalid);

        var state = $selOpt.attr("data-state").toUpperCase() === "JOINING";
        if (state) {
            $("#join_channel_btn").val("表示");
        } else {
            $("#join_channel_btn").val("参加");
        }
        $("#leave_channel_btn").attr("disabled", !state);
    });

    /* Join Channel */
    $("#join_channel_btn").on("click", function() {
        if (valCheck(false)) {
          var $form = $("#join_channel");
          $form.append($("<input></input>").hide().attr("name", "channel_name").val($("#channel option:selected").text()));
          $form.submit();
        }
    });

    /* Join Channel without stomp */
    $("#join_channel_btn_2").on("click", function() {
        if (valCheck(false)) {
          var $form = $("#join_channel").attr("action", "/talk2");
          $form.append($("<input></input>").hide().attr("name", "channel_name").val($("#channel option:selected").text()));
          $form.submit();
        }
    });

    /* Withdrawal Channel */
    $("#leave_channel_btn").on("click", function() {
        $.ajax({
            type: "GET",
            url: /*[[@{'/channel/withdrawal'}]]*/,
            data: {
                  channelId:$("#channel option:selected").val(),
                  userId: $("#user_id").val()
            },
            success: function(result){
                listUpdate();
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    });

    /* Restore closed Channel */
    $("#restore_channel_btn").on("click", function() {
          $.ajax({
              type: "GET",
              url: /*[[@{'/channel/restore'}]]*/,
              data: {channelId:$("#channel option:selected").val()},
              success: function(result){
                  if (result["result"] === "success") {
                      $("#channel option:selected").attr("data-invalid", "false").change();
                      listUpdate();
                  } else {
                      $("#create_err_msg").text("チャンネルの復旧に失敗しました。");
                      $("#make_channel_name").val("");
                  }
              },
              error: function(XMLHttpRequest, textStatus, errorThrown){
              }
          });
    });

    /* Closing Channel */
    $("#close_channel_btn").on("click", function() {
        var channelId = $("#channel option:selected").val();
        $.ajax({
            type: "GET",
            url: /*[[@{'/channel/delete'}]]*/,
            data: {channelId:channelId},
            success: function(result){
                if (result["result"] === "success") {
                    // Connect target channel
                    var chatContext = new ChatContext('ws://' + location.host + '/chat', '/topic/channel/');
                    chatContext.connect(channelId);
                    // Send closed message
                    var msg = {};
                    msg.message ="チャンネルが作成者により閉鎖されました。";
                    msg.user_name = "system";
                    msg.proc = "force_close";
                    chatContext.sendMessage(msg);
                    // Disconnect
                    chatContext.close();
                    listUpdate();
                } else {
                    alert("削除に失敗しました。");
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    });

    /* Create new Channel */
    $("#make_channel_btn").on("click", function() {
        if (valCheck(true)) {
            $.ajax({
                type: "GET",
                url: /*[[@{'/channel/make'}]]*/,
                data: {channelName:$("#make_channel_name").val(),
                       userId:$("#user_id").val()
                },
                success: function(result){
                    if (result["result"] === "success") {
                        listUpdate();
                        var $form = $("#join_channel");
                        $form.append($("<input></input>").hide().attr("name", "channel_name").val(result["name"]));
                        $form.submit();
                    } else {
                        $("#create_err_msg").text("同名のチャンネルがすでに存在するため、別の名前を入力してください。");
                        $("#make_channel_name").val("");
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown){
                }
            });
        }
    });

    function valCheck(isCreate) {
        if (isCreate) {
            if (!!!$("#make_channel_name").val()) {
                alert("チャンネル名を入力してください。");
                return false;
            }
        } else {
            if (!!!$("#channel option:selected").val()) {
                alert("チャンネルを選択してください。");
                return false;
            }
        }
        if (!!!$("#user_name").val()) {
            alert("名前を入力してください。");
            return false;
        }
        return true;
    }

    /* Update Channel List */
    var timerId = null;
    var lastInterval = "0";
    var listUpdate = function() {
        $.ajax({
            type: "GET",
            url: /*[[@{'/channel/listupdate'}]]*/,
            data: {userId:$("#user_id").val()},
            success: function(result){
                result.forEach(function(channels){
                    var state = channels.state === "JOINING" ? "参加中" : "未参加";
                    var condition = channels.condition;
                    var channel = channels.channel;
                    if (!!($("#channel_" + channel.id).val())) {
                        $("#channel_" + channel.id).text(channel.channelName + "（" + condition + "）" + "[" + state + "]").attr("data-invalid",channel.invalidateFlag);
                    } else {
                        // add option
                        var parent = $("#channel");
                        var optTag = $("<option></option>").attr("data-invalid",channel.invalidateFlag)
                                        .attr("data-owner-id", channel.createUserId)
                                        .val(channel.id)
                                        .attr("id", "channel_" + channel.id)
                                        .text(channel.channelName + "（" + state + "）");
                        parent.append(optTag);
                    }
                })
            },
            error: function(XMLHttpRequest, textStatus, errorThrown){
            }
        });
    }
    var doListUpdate = function() {
        listUpdate();
        timerId = setTimeout(doListUpdate, lastInterval * 1000);
    }

    var intervalChange = function() {
        var selInterval = $("#update_interval option:selected").val();
        if (!!timerId
                && (lastInterval !== selInterval)) {
            console.log("clear setTimeout");
            clearTimeout(timerId);
        }
        lastInterval = selInterval;
        if (selInterval == "0") {
            return;
        }
        doListUpdate();
    }

    $("#update_interval").on("change", function() {
        intervalChange();
    });
    intervalChange();
});
//]]>
</script>
</html>
